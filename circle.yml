general:
  branches:
    ignore:
      - master
      - develop

machine:
  php:
    version: 7.0.4
  services:
    - docker

dependencies:
  pre:
    - sudo unlink /usr/lib/apache2/modules/libphp5.so
    - sudo ln -s $PHPENV_ROOT/versions/$(phpenv global)/usr/lib/apache2/modules/libphp5.so /usr/lib/apache2/modules/libphp5.so

  post:
    - cp ~/coralapi/tests/config/coral.apache2 /etc/apache2/sites-available
    - a2ensite coral.apache2
    - sudo service apache2 restart

  cache_directories:
    # automatically cache build docker image between builds
    - "~/docker"

  override:
    - docker info
    - mkdir -p ~/docker

    # Restore docker build image and configure Dockerfile
    - if [[ -e ~/docker/image.tar ]]; then docker load -i ~/docker/image.tar; else  docker pull docker.io/astrilet/testmysql:coral; docker save docker.io/astrilet/testmysql:coral > ~/docker/image.tar; fi

    - docker run -d --name myserver -p 3306:3306 astrilet/testmysql:coral
